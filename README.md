# За пределами анкеты: как звезды, погода и новостной фон влияют на NPS

Этот репозиторий содержит код и материалы для исследования, представленного в рамках доклада на конференции Researсh Expo 25 

## О проекте

Исследование посвящено анализу волатильности метрики NPS (Net Promoter Score) на телеком-рынке. 
Часто стандартный анализ по профилю абонента не может объяснить резкие колебания показателя.
Наша гипотеза заключается в том, что значительная часть этой волатильности является «шумом», вызванным внешним контекстом, в котором находится респондент в момент опроса.

**Основной исследовательский вопрос:** Что в большей степени определяет оценку клиента — то, **КТО** он есть (его "дневник жизни" с оператором и профиль), или то, **ЧТО** происходит вокруг него (внешний контекст)?

Для ответа на этот вопрос мы объединили более 500 тыс. ответов абонентов (2022-2024 гг.) с большим набором внешних данных и построили объясняющую модель на основе машинного обучения (CatBoost).

### Используемые данные

1.  **Внутренние данные:**
    *   Ежедневный трекинг NPS (оценка по шкале от 0 до 10, три сегмента по модели NPS, дата опроса, вес респондента)
    *   Метрики, отвечающие за диагностику Клиентского опыта
    *   Социально-демографический профиль абонента (регион, пол, возраст и т.д.)
      
2.  **Внешние данные:**
    *   **Календарь:** Сезонность, праздники и каникулы, выходные, даты зарплат, «синие понедельники» и т.д.
    *   **Погода:** Температура, осадки, давление, ветер, солнечность и т.д. (с помощью `meteostat`)
    *   **Астрология:** Знаки Солнца, фаза Луны, ретроградность планет, олнечные и лунные затмения, накопленная астронапряженность (с помощью `ephem`)
    *   **Геомагнитная обстановка:** kp и ap-индексы магнитных бурь (архив NOAA)
    *   **Новостной фон:** Ключевые социально-экономические и политические события, агрегированные по тональности и тематике

## Структура проекта

```
nps-context-analysis/
├── data/                 # Папка для всех входных данных
│   ├── events.tsv        # Хронология новостных событий за 22-24 год, собранных с лент ведущих информагентств (ТАСС, Интерфакс, РБК и другие) и каталогизированных по тематикам 
│   ├── kp_index.json     # Данные по kp-индексу
│   └── ap_index.json     # Данные по ap-индексу
│   └── (your_source_dataset.csv) # Исходный датасет с NPS (помещается сюда вручную)
│
├── cache/                # Кэш для погодных данных (создается автоматически)
├── main.py               # Главный скрипт для обогащения данных и обучения модели
├── requirements.txt      # Список необходимых Python-библиотек
└── README.md             # Этот файл
```

## Как запустить

1.  **Скачайте проект:**
    Нажмите зеленую кнопку **`< > Code`** -> **Download ZIP**. Распакуйте архив.

2.  **Установите зависимости:**
    Откройте терминал (командную строку), перейдите в папку с проектом и выполните:
    ```bash
    pip install -r requirements.txt
    ```

3.  **Подготовьте данные:**
    *   Поместите ваш исходный CSV-файл с данными NPS в папку `data/`.
    *   Откройте файл `main.py` в текстовом редакторе и убедитесь, что переменная `SOURCE_DATA_PATH` (строка ~30) указывает на имя вашего файла.

4.  **Запустите скрипт:**
    В терминале, находясь в папке проекта, выполните:
    ```bash
    python main.py
    ```

Скрипт последовательно выполнит обогащение данных, сохранит промежуточный файл `enriched_nps_data.csv.gz`, проведет кросс-валидацию модели и выведет в консоль результаты (метрики качества и важность факторов).


## Практическая значимость

Исследование предоставляет индустрии инструмент для более точной интерпретации колебаний метрик удовлетворенности. Оно позволяет количественно оценить, вызваны ли изменения характеристиками аудитории или внешними событиями, влияющими на всех.
Это помогает избежать неверных выводов, сфокусировать ресурсы на реальных, а не кажущихся проблемах, и повысить точность анализа клиентского опыта в целом.



## Описание переменных отвечающих за Внешний Мир
---

#### Календарь/Праздники

*   **`cal_day_type3` (категориальная)**
    *   **Что это:** Тип дня: рабочий, выходной или праздничный.
    *   **Как считалась:** На основе официального производственного календаря РФ (`holidays`) и дня недели (Сб/Вс — выходные). Праздники имеют приоритет.
    *   **Размерность:** 3 категории {`рабочий`, `выходной`, `праздник`}.

*   **`cal_weekday_4` (категориальная)**
    *   **Что это:** Укрупненный день недели, разделяющий начало, конец рабочей недели и выходные.
    *   **Как считалась:** Группировка дней: {`пн-ср`, `чт-пт`, `сб`, `вс`}.
    *   **Размерность:** 4 категории.

*   **`cal_week_of_month` (категориальная)**
    *   **Что это:** Порядковый номер недели в месяце.
    *   **Как считалась:** Расчет на основе дня месяца и дня недели первого числа.
    *   **Размерность:** 5 категорий {`W1`, `W2`, `W3`, `W4`, `W5`}.
    *   **Источник/библиотека:** `pandas`.

*   **`cal_month_phase3` (категориальная)**
    *   **Что это:** Фаза месяца: начало, середина или конец.
    *   **Как считалась:** Разделение месяца на три декады: 1-10, 11-20, 21-31.
    *   **Размерность:** 3 категории {`начало`, `середина`, `конец`}.

*   **`cal_quarter` (категориальная)**
    *   **Что это:** Квартал года.
    *   **Как считалась:** На основе номера месяца.
    *   **Размерность:** 4 категории {`Q1`, `Q2`, `Q3`, `Q4`}.

*   **`cal_season` (категориальная)**
    *   **Что это:** Астрономическое время года.
    *   **Как считалась:** Группировка месяцев: Дек-Фев (Зима) и т.д.
    *   **Размерность:** 4 категории {`Зима`, `Весна`, `Лето`, `Осень`}.

*   **`cal_holiday_type4` (категориальная)**
    *   **Что это:** Тип праздника, если он есть в этот день.
    *   **Как считалась:** Классификация официальных праздников из `holidays` на ключевые федеральные, Пасху и прочие.
    *   **Размерность:** 4 категории {`нет`, `фед_ключевой`, `религ_пасха`, `прочий`}.

*   **`cal_holiday_window5` (категориальная)**
    *   **Что это:** Близость дня к официальному празднику.
    *   **Как считалась:** Расчет расстояния в днях до ближайшего праздника (вперед или назад).
    *   **Размерность:** 6 категорий {`H-2`, `H-1`, `H0` (сам праздник), `H+1`, `H+2`, `нет_рядом`}.

*   **`cal_long_weekend` (категориальная)**
    *   **Что это:** Признак того, что день является частью "длинных выходных" (3+ нерабочих дня подряд).
    *   **Как считалась:** Поиск последовательностей из 3+ праздничных/выходных дней.
    *   **Размерность:** 2 категории {`да`, `нет`}.
    *   **Источник/библиотека:** `holidays`, `pandas`.

*   **`cal_school_break_ext` (категориальная)**
    *   **Что это:** Принадлежность дня к периоду школьных каникул.
    *   **Как считалась:** На основе стандартных дат каникул в РФ.
    *   **Размерность:** 5 категорий {`нет`, `зима`, `весна`, `лето`, `осень`}.

*   **`cal_payday_proximity` (категориальная)**
    *   **Что это:** Близость дня к типичным датам выплаты зарплаты/аванса (10 и 25 число).
    *   **Как считалась:** Расчет минимального расстояния до 10-го или 25-го числа месяца.
    *   **Размерность:** 4 категории {`день выплаты`, `рядом (±2 дня)`, `неделя до/после`, `далеко`}.

*   **`cal_is_blue_monday` (категориальная)**
    *   **Что это:** Признак "тяжелого понедельника", наступающего после длинных выходных.
    *   **Как считалась:** Проверка, является ли день понедельником, и предшествовал ли ему длинный уикенд.
    *   **Размерность:** 2 категории {`да`, `нет`}.

---

#### Астрология

*   **`знак_Солнца` (категориальная)**
    *   **Что это:** Зодиакальный знак, в котором находилось Солнце в день опроса.
    *   **Как считалась:** Расчет положения Солнца на эклиптике с помощью астрономических эфемерид.
    *   **Размерность:** 12 категорий {`Овен`, ..., `Рыбы`}.

*   **`фаза_луны` (категориальная)**
    *   **Что это:** Укрупненная фаза луны.
    *   **Как считалась:** На основе процента освещенности лунного диска.
    *   **Размерность:** 4 категории {`Новолуние`, `Растущая`, `Полнолуние`, `Убывающая`}.

*   **`lunar_day_cat` (категориальная)**
    *   **Что это:** Укрупненный лунный день (от 1 до ~30), сгруппированный по неделям лунного месяца.
    *   **Как считалась:** Расчет времени с момента последнего новолуния.
    *   **Размерность:** 4 категории {`1-7`, `8-14`, `15-21`, `22-30`}.

*   **`is_retrograde_any_cat` (категориальная)**
    *   **Что это:** Была ли хотя бы одна из отслеживаемых планет (кроме Солнца и Луны) в ретроградном движении.
    *   **Как считалась:** Проверка скорости движения планет. Отрицательная скорость означает ретроградность.
    *   **Размерность:** 2 категории {`да`, `нет`}.

*   **`is_station_any_cat` (категориальная)**
    *   **Что это:** Меняла ли какая-либо планета направление движения (с прямого на ретроградное или наоборот). Это явление называется стационарностью.
    *   **Как считалась:** Сравнение направления движения планеты сегодня и вчера.
    *   **Размерность:** 2 категории {`да`, `нет`}.

*   **`is_ingress_any_cat` (категориальная)**
    *   **Что это:** Переходила ли какая-либо планета в новый зодиакальный знак (ингрессия).
    *   **Как считалась:** Сравнение зодиакального знака планеты сегодня и вчера.
    *   **Размерность:** 2 категории {`да`, `нет`}.

*   **`солнечное_затмение_cat` / `лунное_затмение_cat` (категориальные)**
    *   **Что это:** Находился ли день опроса в "коридоре затмений" (±3 дня от точной даты).
    *   **Как считалась:** Проверка близости даты опроса к заранее заданному списку дат затмений.
    *   **Размерность:** 2 категории {`да`, `нет`}.

*   **`hard_aspects_cat` (категориальная)**
    *   **Что это:** Количество "напряженных" астрологических аспектов (соединение, квадрат, оппозиция) между всеми планетами.
    *   **Как считалась:** Расчет угловых расстояний между парами планет.
    *   **Размерность:** 3 категории {`0`, `1`, `>=2`}.

*   **`pp_hard_aspects_cat` (категориальная)**
    *   **Что это:** Количество "напряженных" аспектов только между "личными" планетами (Солнце, Луна, Меркурий, Венера, Марс).
    *   **Как считалась:** Аналогично `hard_aspects_cat`, но для ограниченного набора планет.
    *   **Размерность:** 3 категории {`0`, `1`, `>=2`}.

*   **`astro_weighted_aspects_cat` (категориальная)**
    *   **Что это:** Взвешенное количество напряженных аспектов, где аспекты с участием "тяжелых" планет (Сатурн, Уран и т.д.) имеют больший вес.
    *   **Как считалась:** Суммирование напряженных аспектов с весами (2 для тяжелых планет, 1 для остальных).
    *   **Размерность:** 4 категории {`0`, `1-2`, `3-4`, `5+`}.

*   **`is_hecate_moon_cat` (категориальная)**
    *   **Что это:** Признак "дней Гекаты" — последних двух дней перед новолунием.
    *   **Как считалась:** Проверка, что до следующего новолуния осталось менее 2.5 дней.
    *   **Размерность:** 2 категории {`да`, `нет`}.

*   **`astro_moon_voc_proxy_cat` (категориальная)**
    *   **Что это:** Прокси-признак "Луны без курса" (упрощенно: Луна в конце знака).
    *   **Как считалась:** Проверка, находится ли Луна в последних 3 градусах (27-30) зодиакального знака.
    *   **Размерность:** 2 категории {`да`, `нет`}.

*   **`astro_interaction_merc_mars` (категориальная)**
    *   **Что это:** Комбинированный признак одновременного наличия ретроградного Меркурия и напряженного аспекта к Марсу.
    *   **Как считалась:** Логическое "И" для двух условий.
    *   **Размерность:** 2 категории {`да`, `нет`}.

*   **`astro_tension_last5_cat` (категориальная)**
    *   **Что это:** **(Лаг)** Интегральный "индекс напряженности" за последние 5 дней.
    *   **Как считалась:** Сумма взвешенных астро-событий (ретроградность, ингрессии, затмения) за предыдущие 5 дней.
    *   **Размерность:** 5 категорий {`Спокойно`, `Легкое напряжение`, `Среднее`, `Высокое`, `Очень высокое`}.

---

#### Погода

*   **`wth_daylight_duration_cat` (категориальная)**
    *   **Что это:** Продолжительность светового дня.
    *   **Как считалась:** Астрономический расчет времени между восходом и закатом Солнца для координат региона.
    *   **Размерность:** 4 категории {`очень короткий`, `короткий`, `длинный`, `очень длинный`}.

*   **`wth_sunshine_ratio_cat` (категориальная)**
    *   **Что это:** Доля солнечного времени в течение светового дня (показывает, был ли день ясным или пасмурным).
    *   **Как считалась:** Отношение количества минут солнечного сияния (`tsun`) к общей продолжительности светового дня.
    *   **Размерность:** 4 категории {`пасмурно`, `облачно`, `переменная облачность`, `ясно`}.

*   **`wth_temp_feels_like_cat` (категориальная)**
    *   **Что это:** Ощущаемая температура с учетом ветра ("wind chill").
    *   **Как считалась:** Расчет по метеорологической формуле на основе средней температуры и скорости ветра.
    *   **Размерность:** 5 категорий {`экстр. холод`, `холод`, `прохладно`, `комфорт`, `жара`}.

*   **`wth_precipitation_cat` (категориальная)**
    *   **Что это:** Интенсивность осадков за день.
    *   **Как считалась:** На основе количества осадков в миллиметрах.
    *   **Размерность:** 4 категории {`без осадков`, `легкие`, `умеренные`, `сильные`}.

*   **`wth_wind_speed_cat` (категориальная)**
    *   **Что это:** Сила ветра.
    *   **Как считалась:** На основе средней скорости ветра в км/ч.
    *   **Размерность:** 4 категории {`штиль`, `слабый`, `умеренный`, `сильный`}.
    *   **Источник/библиотека:** `meteostat`.

*   **`wth_complex_weather_cat` (категориальная)**
    *   **Что это:** Комплексная оценка погоды как "экстремальной", "с осадками" или "спокойной".
    *   **Как считалась:** Комбинация условий: сильные осадки, сильный ветер или очень низкая ощущаемая температура.
    *   **Размерность:** 3 категории {`экстремальная`, `осадки`, `спокойная`}.

*   **`wth_temp_change_cat`, `wth_precipitation_change_cat`, `wth_pressure_change_cat`, `wth_wind_speed_change_cat` (категориальные)**
    *   **Что это:** **(Динамика)** Ключевая группа признаков, описывающая *изменение* погоды по сравнению с предыдущим днем (похолодание, начало осадков, падение давления и т.д.).
    *   **Как считалась:** Расчет разницы (`.diff()`) значений метеопараметров между текущим и предыдущим днем для каждого региона.
    *   **Размерность:** 5 категорий для каждого признака.

*   **`wth_seasonal_temp_anomaly_cat` (категориальная)**
    *   **Что это:** Отклонение температуры дня от исторической нормы для данного месяца и региона.
    *   **Как считалась:** Разница между фактической температурой и средней температурой за прошлые годы для этого месяца.
    *   **Размерность:** 5 категорий {`сильно холоднее`, `холоднее нормы`, `норма`, `теплее нормы`, `сильно теплее`}.

*   **`wth_bad_weather_last5_cat` / `wth_extreme_temp_last5_cat` (категориальные)**
    *   **Что это:** **(Лаги)** Накопительный эффект: количество дней с "плохой" погодой или с экстремальной температурной аномалией за последние 5 дней.
    *   **Как считалась:** Скользящая сумма (`.rolling().sum()`) по соответствующим бинарным признакам.
    *   **Размерность:** 4 категории для каждого признака.
    *   **Источник/библиотека:** `pandas`.

*   **`wth_national_bad_weather_scale_cat` / `wth_national_temp_anomaly_scale_cat` (категориальные)**
    *   **Что это:** **(Масштаб)** Оценка того, насколько распространена плохая погода / температурная аномалия по стране в данный день.
    *   **Как считалась:** Доля регионов, в которых наблюдалось соответствующее погодное явление.
    *   **Размерность:** 4 категории {`локально`, `местами`, `многие регионы`, `по всей стране`}.


#### Магнитные бури 

*   **`mag_storm_level_cat` (категориальная)**
    *   **Что это:** Уровень геомагнитной активности (магнитной бури) в день опроса.
    *   **Как считалась:** На основе среднесуточного Kp-индекса, который бинировался по общепринятой шкале NOAA.
    *   **Размерность:** 5 категорий {`спокойно`, `слабая буря`, `умеренная буря`, `сильная буря`, `экстремальная буря`}.


*   **`mag_storm_change_cat` (категориальная)**
    *   **Что это:** **(Динамика)** Насколько резко изменилась геомагнитная обстановка по сравнению со вчерашним днем.
    *   **Как считалась:** Разница Kp-индекса между текущим и вчерашним днем.
    *   **Размерность:** 5 категорий {`резкий рост`, `рост`, `стабильно`, `падение`, `резкое падение`}.

#### Новости

*   **`news_day_group7` (категориальная)**
    *   **Что это:** Преобладающая тематика новостей в данный день.
    *   **Как считалась:** Каждое событие из списка классифицировалось в одну из 7 укрупненных групп. В признак попадала группа с наибольшим числом событий за день.
    *   **Размерность:** 8 категорий (7 групп + `нет` событий).

*   **`news_tone_day_cat` (категориальная)**
    *   **Что это:** Общая тональность новостного фона дня.
    *   **Как считалась:** Каждой группе новостей присвоен вес (от -2 для "Безопасность/ЧС" до +1 для "Праздники"). Тональность дня — это сумма весов всех событий.
    *   **Размерность:** 5 категорий {`сильно негативный`, `негативный`, `нейтральный`, `позитивный`, `сильно позитивный`}.

*   **`news_tone_change_cat` (категориальная)**
    *   **Что это:** **(Динамика)** Резкость изменения тональности новостей по сравнению со вчерашним днем.
    *   **Как считалась:** Разница между `news_tone_day` сегодня и вчера.
    *   **Размерность:** 5 категорий {`резко негативнее`, `негативнее`, `без изменений`, `позитивнее`, `резко позитивнее`}.

*   **`news_burst_last5_cat` (категориальная)**
    *   **Что это:** **(Лаг)** Информационная насыщенность — общее количество новостных событий за последние 5 дней.
    *   **Как считалась:** Скользящая сумма по количеству событий в день.
    *   **Размерность:** 4 категории {`0`, `1-2`, `3-5`, `6+`}.

*   **`news_topics_last5_cat` (категориальная)**
    *   **Что это:** **(Лаг)** Тематическое разнообразие новостей за последние 5 дней.
    *   **Как считалась:** Количество уникальных новостных групп, которые были активны за последние 5 дней.
    *   **Размерность:** 4 категории {`0`, `1-2`, `3-4`, `5+`}.

*   **`news_tone_last5_cat` (категориальная)**
    *   **Что это:** **(Лаг)** Средняя тональность новостного фона за последние 5 дней.
    *   **Как считалась:** Скользящее среднее по признаку `news_tone_day`.
    *   **Размерность:** 5 категорий (аналогично `news_tone_day_cat`).

*   **`news_macro_risk_last5_cat`, `news_security_risk_last5_cat`, `news_it_pay_last5_cat`, `news_energy_last5_cat` (категориальные)**
    *   **Что это:** **(Лаги)** Активность новостей в ключевых тематических блоках за последние 5 дней.
    *   **Как считалась:** Скользящая сумма событий, относящихся к определенным группам.
    *   **Размерность:** 3-4 категории для каждого признака.

*   **`news_recency_major_cat` (категориальная)**
    *   **Что это:** **(Лаг)** Сколько дней прошло с последнего крупного негативного события (из групп "Безопасность/ЧС" или "Санкции/финансы").
    *   **Как считалась:** Расчет разницы в днях с последним "мажорным" событием.
    *   **Размерность:** 4 категории {`0-1`, `2-3`, `4-7`, `>7`}.

*   **`news_span_last14_cat` (категориальная)**
    *   **Что это:** **(Лаг)** Плотность информационного потока — количество дней с какими-либо новостями за последние 2 недели.
    *   **Как считалась:** Скользящая сумма по дням, в которые были события.
    *   **Размерность:** 4 категории {`0-2`, `3-5`, `6-9`, `10-14`}.

*   **`news_holiday_overlay_cat` (категориальная)**
    *   **Что это:** Взаимодействие новостного фона и праздников.
    *   **Как считалась:** Проверка, были ли в праздничный день какие-либо значимые события.
    *   **Размерность:** 3 категории {`нет` (не праздник), `праздник+события`, `праздник_без_событий`}.


### Пример расчетов Перепадов для Погоды

#### `wth_pressure_change_cat` (Изменение атмосферного давления)

*   **Что это:** Категория, описывающая, насколько сильно и в какую сторону изменилось атмосферное давление по сравнению с предыдущим днем. Этот показатель напрямую связан с прохождением атмосферных фронтов (циклонов и антициклонов) и часто влияет на самочувствие метеозависимых людей.

*   **Как считалась (по шагам):**
    1.  **Исходная переменная:** `pres` — среднее давление за сутки на уровне моря в гектопаскалях (гПа), полученное от `meteostat`.
    2.  **Вычисление разницы:** Для каждого региона отдельно вычислялась разница между давлением сегодня и давлением вчера.
        ```python
        pressure_change = out.groupby('region_std')['pres'].diff()
        ```
        `groupby('region_std')` гарантирует, что мы сравниваем давление в Москве сегодня с давлением в Москве вчера. `diff()` вычисляет эту разницу.
    3.  **Категоризация:** Полученная разница (например, -7.5 гПа) категоризировалась с помощью `pd.cut` по следующим порогам:
        *   `сильное падение`: изменение ≤ -5 гПа
        *   `падение`: изменение от -5 до -1 гПа
        *   `стабильно`: изменение от -1 до +1 гПа
        *   `рост`: изменение от +1 до +5 гПа
        *   `сильный рост`: изменение ≥ +5 гПа
---

#### `wth_precipitation_change_cat` (Изменение характера осадков)

*   **Что это:** Этот признак описывает не количество, а *событие* изменения осадков. Начался ли дождь/снег, когда вчера его не было? Или наоборот, прекратился?

*   **Как считалась (по шагам):**
    1.  **Исходная переменная:** `precipitation_mm` — суммарное количество осадков за сутки в мм.
    2.  **Логика сравнения:** Вместо простого вычитания использовалась более сложная логика на основе `numpy.select`, чтобы поймать качественные изменения:
        *   **Вчера было сухо (`precip_prev <= 0`), сегодня мокро (`precip_current > 0`)** → `Начались осадки`
        *   **Вчера было мокро (`precip_prev > 0`), сегодня сухо (`precip_current <= 0`)** → `Осадки прекратились`
        *   **И вчера, и сегодня мокро, но сегодня больше** → `Осадки усилились`
        *   **И вчера, и сегодня мокро, но сегодня меньше** → `Осадки ослабли`
        *   **Во всех остальных случаях (например, оба дня сухо)** → `Без изменений`
    3.  **Гипотеза/Интерпретация:** Психологически, **начало** дождя — более сильный негативный триггер, чем его продолжение. Человек, планировавший день в расчете на сухую погоду, будет более раздосадован внезапными осадками. Прекращение осадков, наоборот, может иметь позитивный эффект.
